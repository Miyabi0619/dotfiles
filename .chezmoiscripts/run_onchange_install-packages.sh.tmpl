#!/bin/sh

# Exit on error
set -e

# Function to check if a command exists
command_exists() {
  command -v "$1" >/dev/null 2>&1
}

{{ if eq .chezmoi.os "linux" -}}
### For Linux (Debian/Ubuntu) ###

# --- APT Packages ---
if command_exists apt-get; then
  echo "INFO: Updating apt repository..."
  sudo apt-get update

  echo "INFO: Installing apt packages from packages/apt.txt..."
  # Read packages from apt.txt, ignore comments/empty lines, and install
  grep -vE '^\s*(#|$)' {{ joinPath .chezmoi.sourceDir "packages/apt.txt" | quote }} | xargs -r sudo apt-get install -y
else
  echo "WARN: apt-get command not found. Skipping apt packages."
fi

# --- Snap Packages ---
if command_exists snap; then
  echo "INFO: Installing snap packages from packages/snap.txt..."
  # Read packages from snap.txt, ignore comments/empty lines, and install
  grep -vE '^\s*(#|$)' {{ joinPath .chezmoi.sourceDir "packages/snap.txt" | quote }} | xargs -r -n 1 sudo snap install
else
  echo "WARN: snap command not found. Skipping snap packages."
fi

# --- Cargo Packages (sheldon, starship) ---
if command_exists cargo; then
  echo "INFO: Installing cargo packages (sheldon, starship)..."
  cargo install sheldon starship
else
  echo "WARN: cargo command not found. Installing Rust first..."
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
  . "$HOME/.cargo/env"
  echo "INFO: Installing cargo packages (sheldon, starship)..."
  cargo install sheldon starship
fi

{{ else if eq .chezmoi.os "darwin" -}}
### For macOS ###
# Brewfile hash: {{ include "dot_Brewfile" | sha256sum }}

# --- Homebrew ---
if command_exists brew; then
  echo "INFO: Installing Homebrew packages from ~/.Brewfile..."
  brew bundle --file="${HOME}/.Brewfile"
else
  echo "WARN: brew command not found. Installing Homebrew first..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Add Homebrew to PATH for Apple Silicon Macs
  if [ -f "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi

  echo "INFO: Installing Homebrew packages from ~/.Brewfile..."
  brew bundle --file="${HOME}/.Brewfile"
fi

{{ else if eq .chezmoi.os "windows" -}}
### For Windows ###
echo "INFO: Windows detected. Winget logic would be in a .ps1.tmpl script."

{{ else }}
echo "WARN: Unsupported OS: {{ .chezmoi.os }}"
{{ end }}

echo "INFO: Package installation script finished."
